<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç ‚Äî –û–û–û ¬´–°–ï–†–í–ò–°–¢–†–ê–ù–°–ê–í–¢–û¬ª</title>
  <style>
    :root {
      --primary: #007bff;
      --danger: #dc3545;
      --success: #28a745;
      --border: #ddd;
      --bg: #fff;
      --text: #333;
    }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: #f8f9fa;
      padding: 20px;
      margin: 0;
      font-size: 14px;
      line-height: 1.5;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      background: var(--bg);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tab-btn {
      padding: 8px 16px;
      background: #e9ecef;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }
    .tab-btn.active {
      background: var(--primary);
      color: white;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .header-info {
      margin-bottom: 20px;
      padding: 12px;
      background: #fafafa;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin: 12px 0;
    }
    .form-group {
      flex: 1;
      min-width: 200px;
    }
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 4px;
      color: #444;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    h3 {
      text-align: center;
      margin: 20px 0 12px;
      color: var(--text);
      font-size: 16px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
      font-size: 13px;
    }
    th, td {
      text-align: left;
      padding: 8px 6px;
      border: 1px solid var(--border);
    }
    thead th {
      font-weight: 600;
      background: #f8f9fa;
    }

    .btn {
      padding: 8px 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 15px;
      font-weight: bold;
      margin: 5px;
    }
    .btn-sm { padding: 4px 8px; font-size: 12px; }
    .btn-delete { background: var(--danger); padding: 2px 6px; font-size: 12px; }
    .no-print { display: none; } /* –°–∫—Ä—ã—Ç–æ –ø—Ä–∏ –ø–µ—á–∞—Ç–∏ */

    .signature-line {
      margin-top: 30px;
      display: flex;
      align-items: flex-end;
      gap: 30px;
    }
    .signature-block {
      width: 50%;
    }

    @media print {
      .no-print { display: block; }
      body { background: white; padding: 0; }
      .container { box-shadow: none; border: none; }
    }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
</head>
<body>

<div class="container">
  <div id="auth-ui" style="position: fixed; top: 10px; right: 10px; background: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 4px; z-index: 999;">
    <div id="user-status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <button id="sign-in-btn" style="display:none;" onclick="signInWithGoogle()">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
    <button id="sign-out-btn" style="display:none;" onclick="signOut()">–í—ã—Ö–æ–¥</button>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('form')">–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç</button>
    <button class="tab-btn" onclick="switchTab('archive')">–ê—Ä—Ö–∏–≤</button>
  </div>

  <!-- === –§–û–†–ú–ê === -->
  <div id="form-tab" class="tab-content active">
    <div class="header-info">
      <strong>–ü–û–°–¢–ê–í–©–ò–ö:</strong> –û–±—â–µ—Å—Ç–≤–æ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å—é "–°–ï–†–í–ò–°–¢–†–ê–ù–°–ê–í–¢–û"<br>
      –ò–ù–ù 7723905004, –ö–ü–ü 772101001, –ö–æ–¥ –ø–æ –û–ö–ü–û 29289257<br>
      111674, –≥. –ú–æ—Å–∫–≤–∞, –≤–Ω.—Ç–µ—Ä.–≥. –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥ –ù–µ–∫—Ä–∞—Å–æ–≤–∫–∞, –ø—Ä-–∫—Ç –ó–∞—â–∏—Ç–Ω–∏–∫–æ–≤ –ú–æ—Å–∫–≤—ã<br>
      —Ç–µ–ª.: +7 999 599 00 03
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>–î–∞—Ç–∞</label>
        <input type="text" id="current-date" readonly>
      </div>
      <div class="form-group">
        <label>–ù–æ–º–µ—Ä –Ω–∞—Ä—è–¥–∞</label>
        <input type="text" id="order-number" placeholder="–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>–ö–æ–º–ø–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞</label>
        <input type="text" id="client-company" placeholder="–û–û–û / –ò–ü / –§–ò–û –∫–ª–∏–µ–Ω—Ç–∞">
      </div>
      <div class="form-group">
        <label>–ö–æ–Ω—Ç–∞–∫—Ç</label>
        <input type="text" id="contact" placeholder="–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ / —Ç–µ–ª–µ—Ñ–æ–Ω">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>–ú–∞—Å—Ç–µ—Ä</label>
        <input type="text" id="master" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò.">
      </div>
      <div class="form-group">
        <label>–§–ò–û –∫–ª–∏–µ–Ω—Ç–∞</label>
        <input type="text" id="client-name" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò.">
      </div>
      <div class="form-group">
        <label>–ú–∞—Ä–∫–∞</label>
        <input type="text" id="car-brand" placeholder="–ì–ê–ó–µ–ª—å, Ford Transit...">
      </div>
      <div class="form-group">
        <label>–ì–æ—Å. –Ω–æ–º–µ—Ä</label>
        <input type="text" id="car-number" placeholder="A111BB77">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>–ü—Ä–æ–±–µ–≥ (–∫–º)</label>
        <input type="number" id="mileage" value="123456" min="0">
      </div>
    </div>

    <h3>–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–∞–±–æ—Ç—ã</h3>
    <table id="works-table">
      <thead>
        <tr>
          <th>‚Ññ</th>
          <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
          <th>–ö–æ–ª-–≤–æ</th>
          <th>–°—Ç–æ—Ä–æ–Ω–∞</th>
          <th>–ü–æ–ª–æ–∂–µ–Ω–∏–µ</th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody id="works-body">
        <!-- —Å—Ç—Ä–æ–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </tbody>
    </table>
    <button class="btn btn-sm" onclick="addWorkRow()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>

    <h3>–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</h3>
    <table id="completed-table">
      <thead>
        <tr>
          <th>‚Ññ</th>
          <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
          <th>–ö–æ–ª-–≤–æ</th>
          <th>–°—Ç–æ—Ä–æ–Ω–∞</th>
          <th>–ü–æ–ª–æ–∂–µ–Ω–∏–µ</th>
          <th>–¶–µ–Ω–∞</th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody id="completed-body">
        <!-- —Å—Ç—Ä–æ–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </tbody>
    </table>
    <button class="btn btn-sm" onclick="addCompletedRow()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>

    <div class="no-print">
      <button class="btn" onclick="printClaim()">üìÑ –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —Ä–µ–º–æ–Ω—Ç</button>
    </div>
  </div>

  <!-- === –ê–†–•–ò–í === -->
  <div id="archive-tab" class="tab-content">
    <h2>–ê—Ä—Ö–∏–≤ –∑–∞—è–≤–æ–∫</h2>
    <div id="archive-list" class="archive-list"></div>
    <div class="no-print" style="margin-top:20px;">
      <button class="btn btn-archive" style="background:#6c757d;" onclick="switchTab('form')">‚Üê –ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç</button>
    </div>
  </div>
</div>

<script>
  // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE ===
  const firebaseConfig = {
    apiKey: "AIzaSyDixYVempEv1EIehC_oSMI98stT61deZ6Y",
    authDomain: "servistransavto-danik.firebaseapp.com",
    databaseURL: "https://servistransavto-danik-default-rtdb.firebaseio.com",
    projectId: "servistransavto-danik",
    storageBucket: "servistransavto-danik.firebasestorage.app",
    messagingSenderId: "770451755248",
    appId: "1:770451755248:web:94874fca1cb9843945f235"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const database = firebase.database();

  let currentUser = null;
  let userRole = null;
  let workIndex = 1;
  let completedIndex = 1;

  // === –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ===
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      document.getElementById('user-status').innerHTML = `üë§ ${user.displayName}`;
      document.getElementById('sign-in-btn').style.display = 'none';
      document.getElementById('sign-out-btn').style.display = 'inline-block';

      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–æ–ª—å –∏–∑ –±–∞–∑—ã
      database.ref('users/' + user.uid).once('value')
        .then(snapshot => {
          const data = snapshot.val();
          if (data && data.role) {
            userRole = data.role;
            console.log('–†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userRole);
            loadArchive(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—Ä—Ö–∏–≤, –∫–æ–≥–¥–∞ —Ä–æ–ª—å –∏–∑–≤–µ—Å—Ç–Ω–∞
            if (userRole === 'admin') {
              document.getElementById('user-status').innerHTML += ` (–ê–¥–º–∏–Ω)`;
            }
          } else {
            alert('‚ö†Ô∏è –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ —Å–∏—Å—Ç–µ–º–µ. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.');
            signOut();
          }
        });
    } else {
      currentUser = null;
      userRole = null;
      document.getElementById('user-status').textContent = '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
      document.getElementById('sign-in-btn').style.display = 'inline-block';
      document.getElementById('sign-out-btn').style.display = 'none';
    }
  });

  function signInWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider)
      .then(result => {
        alert(`‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${result.user.displayName}!`);
      })
      .catch(error => {
        alert('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
      });
  }

  function signOut() {
    auth.signOut()
      .then(() => {
        alert('üëã –í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã.');
        window.location.reload();
      })
      .catch(error => {
        alert('‚ùå –û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ' + error.message);
      });
  }

  // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
  document.addEventListener('DOMContentLoaded', () => {
    const now = new Date();
    const d = `${String(now.getDate()).padStart(2, '0')}.${String(now.getMonth() + 1).padStart(2, '0')}.${now.getFullYear()}`;
    document.getElementById('current-date').value = d;
    generateOrderNumber();
    loadArchive();
  });

  function generateOrderNumber() {
    const lastSeq = parseInt(localStorage.getItem('lastClaimSeq') || '0');
    const newSeq = lastSeq + 1;
    localStorage.setItem('lastClaimSeq', newSeq.toString());
    document.getElementById('order-number').value = `–°–¢–ê-${new Date().getFullYear()}-${String(newSeq).padStart(3, '0')}`;
  }

  function addWorkRow() {
    const tbody = document.getElementById('works-body');
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${workIndex}</td>
      <td><input type="text" placeholder="–ó–∞–º–µ–Ω–∞ –º–∞—Å–ª–∞" /></td>
      <td><input type="number" value="1" min="1" /></td>
      <td><select><option>–õ–µ–≤–∞—è</option><option>–ü—Ä–∞–≤–∞—è</option><option>–ü–µ—Ä–µ–¥–Ω—è—è</option><option>–ó–∞–¥–Ω—è—è</option></select></td>
      <td><select><option>–í–µ—Ä—Ö</option><option>–ù–∏–∑</option><option>–¶–µ–Ω—Ç—Ä</option></select></td>
      <td><button class="btn-delete" onclick="deleteRow(this)">üóëÔ∏è</button></td>
    `;
    tbody.appendChild(row);
    workIndex++;
  }

  function addCompletedRow() {
    const tbody = document.getElementById('completed-body');
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${completedIndex}</td>
      <td><input type="text" placeholder="–ó–∞–º–µ–Ω–∞ –º–∞—Å–ª–∞" /></td>
      <td><input type="number" value="1" min="1" /></td>
      <td><select><option>–õ–µ–≤–∞—è</option><option>–ü—Ä–∞–≤–∞—è</option><option>–ü–µ—Ä–µ–¥–Ω—è—è</option><option>–ó–∞–¥–Ω—è—è</option></select></td>
      <td><select><option>–í–µ—Ä—Ö</option><option>–ù–∏–∑</option><option>–¶–µ–Ω—Ç—Ä</option></select></td>
      <td><input type="number" value="0" min="0" placeholder="–¶–µ–Ω–∞" /></td>
      <td><button class="btn-delete" onclick="deleteRow(this)">üóëÔ∏è</button></td>
    `;
    tbody.appendChild(row);
    completedIndex++;
  }

  function deleteRow(button) {
    button.closest('tr').remove();
  }

  function switchTab(tab) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(`${tab}-tab`).classList.add('active');
    document.querySelector(`.tab-btn:nth-child(${tab === 'form' ? 1 : 2})`).classList.add('active');

    if (tab === 'archive') {
      renderArchive();
    }
  }

  function renderArchive() {
    const archiveList = document.getElementById('archive-list');
    archiveList.innerHTML = '';

    database.ref('claims').orderByChild('header/date').once('value')
      .then(snapshot => {
        const claims = [];
        snapshot.forEach(childSnapshot => {
          claims.push({ id: childSnapshot.key, ...childSnapshot.val() });
        });

        // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ
        const grouped = {};
        claims.forEach(claim => {
          const date = claim.header.date.split('.')[2]; // –≥–æ–¥
          if (!grouped[date]) grouped[date] = [];
          grouped[date].push(claim);
        });

        for (const year in grouped) {
          const yearDiv = document.createElement('div');
          yearDiv.className = 'archive-date-header';
          yearDiv.textContent = `üìÖ ${year}`;
          archiveList.appendChild(yearDiv);

          grouped[year].forEach(claim => {
            const item = document.createElement('div');
            item.className = 'archive-item';
            item.innerHTML = `
              <strong>‚Ññ${claim.header.order}</strong> ‚Äî ${claim.header.clientCompany}
              <br>–ê–≤—Ç–æ–º–æ–±–∏–ª—å: ${claim.header.carModel} (${claim.header.carNumber})
              <br>–î–∞—Ç–∞: ${claim.header.date}
              <div class="archive-status status-${claim.header.status}">
                ${claim.header.status === 'zayavka' ? '–ó–∞—è–≤–∫–∞' : '–ó–∞–∫–∞–∑-–Ω–∞—Ä—è–¥'}
              </div>
              <div class="archive-actions">
                <button class="btn-sm" onclick="loadClaim('${claim.id}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn-sm btn-delete" onclick="deleteClaim('${claim.id}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
              </div>
            `;
            archiveList.appendChild(item);
          });
        }
      })
      .catch(err => {
        archiveList.innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ö–∏–≤–∞.</p>';
      });
  }

  function deleteClaim(id) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;

    database.ref('claims/' + id).remove()
      .then(() => {
        alert('‚úÖ –ó–∞—è–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞.');
        renderArchive();
      })
      .catch(err => {
        alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è.');
      });
  }

  function loadClaim(claimId) {
    if (userRole !== 'admin') {
      alert('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞—è–≤–∫–∏.');
      return;
    }

    database.ref('claims/' + claimId).once('value')
      .then(snapshot => {
        const claim = snapshot.val();
        if (!claim) return;

        if (claim.header.status === 'zakaz_naryad') {
          alert('üîí –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç ‚Äî –∑–∞–∫–∞–∑-–Ω–∞—Ä—è–¥. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ.');
          renderReadOnlyPreview(claim);
          return;
        }

        // –†–∞–∑—Ä–µ—à–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        fillFormFromClaim(claim, claimId);
        switchTab('form');
      });
  }

  function fillFormFromClaim(claim, claimId) {
    document.getElementById('claim-id').value = claimId;
    document.getElementById('current-date').value = claim.header.date;
    document.getElementById('order-number').value = claim.header.order;
    document.getElementById('client-company').value = claim.header.clientCompany;
    document.getElementById('contact').value = claim.header.contact;
    document.getElementById('master').value = claim.header.master;
    document.getElementById('client-name').value = claim.header.clientName;
    document.getElementById('car-brand').value = claim.header.carBrand;
    document.getElementById('car-number').value = claim.header.carNumber;
    document.getElementById('mileage').value = claim.header.mileage;

    // –û—á–∏—Å—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü
    document.getElementById('works-body').innerHTML = '';
    document.getElementById('completed-body').innerHTML = '';

    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç
    claim.works.forEach(work => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${work.id}</td>
        <td><input type="text" value="${work.description}" /></td>
        <td><input type="number" value="${work.quantity}" min="1" /></td>
        <td><select><option>–õ–µ–≤–∞—è</option><option>–ü—Ä–∞–≤–∞—è</option><option>–ü–µ—Ä–µ–¥–Ω—è—è</option><option>–ó–∞–¥–Ω—è—è</option></select></td>
        <td><select><option>–í–µ—Ä—Ö</option><option>–ù–∏–∑</option><option>–¶–µ–Ω—Ç—Ä</option></select></td>
        <td><button class="btn-delete" onclick="deleteRow(this)">üóëÔ∏è</button></td>
      `;
      document.getElementById('works-body').appendChild(row);
    });

    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç
    claim.completed.forEach(completed => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${completed.id}</td>
        <td><input type="text" value="${completed.description}" /></td>
        <td><input type="number" value="${completed.quantity}" min="1" /></td>
        <td><select><option>–õ–µ–≤–∞—è</option><option>–ü—Ä–∞–≤–∞—è</option><option>–ü–µ—Ä–µ–¥–Ω—è—è</option><option>–ó–∞–¥–Ω—è—è</option></select></td>
        <td><select><option>–í–µ—Ä—Ö</option><option>–ù–∏–∑</option><option>–¶–µ–Ω—Ç—Ä</option></select></td>
        <td><input type="number" value="${completed.price}" min="0" /></td>
        <td><button class="btn-delete" onclick="deleteRow(this)">üóëÔ∏è</button></td>
      `;
      document.getElementById('completed-body').appendChild(row);
    });

    workIndex = claim.works.length + 1;
    completedIndex = claim.completed.length + 1;
  }

  function prepareData() {
    const order = document.getElementById('order-number').value;
    const clientCompany = document.getElementById('client-company').value;
    const contact = document.getElementById('contact').value;
    const master = document.getElementById('master').value;
    const clientName = document.getElementById('client-name').value;
    const carBrand = document.getElementById('car-brand').value;
    const carNumber = document.getElementById('car-number').value;
    const mileage = document.getElementById('mileage').value;

    if (!order || !clientCompany || !contact || !master || !clientName || !carBrand) {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!');
      return null;
    }

    const works = [];
    Array.from(document.querySelectorAll('#works-body tr')).forEach((row, i) => {
      const cells = row.querySelectorAll('input, select');
      const description = cells[0].value;
      const quantity = cells[1].value;
      const side = cells[2].value;
      const position = cells[3].value;
      if (description && quantity > 0) {
        works.push({
          id: i + 1,
          description,
          quantity,
          side,
          position
        });
      }
    });

    const completed = [];
    Array.from(document.querySelectorAll('#completed-body tr')).forEach((row, i) => {
      const cells = row.querySelectorAll('input, select');
      const description = cells[0].value;
      const quantity = cells[1].value;
      const side = cells[2].value;
      const position = cells[3].value;
      const price = cells[4].value;
      if (description && quantity > 0) {
        completed.push({
          id: i + 1,
          description,
          quantity,
          side,
          position,
          price
        });
      }
    });

    return {
      header: {
        order,
        date: document.getElementById('current-date').value,
        clientCompany,
        contact,
        master,
        clientName,
        carBrand,
        carNumber,
        mileage,
        status: 'zayavka',
        userId: currentUser ? currentUser.uid : 'anonymous'
      },
      works,
      completed
    };
  }

  function saveOrUpdateClaim(data) {
    const claimId = document.getElementById('claim-id').value;
    let ref;

    if (claimId) {
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é
      ref = database.ref('claims/' + claimId);
    } else {
      // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é
      ref = database.ref('claims').push();
      data.id = ref.key;
    }

    ref.set(data)
      .then(() => {
        alert(`‚úÖ –ó–∞—è–≤–∫–∞ ‚Ññ${data.header.order} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!`);
        resetForm();
        loadArchive();
      })
      .catch(err => {
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ.');
      });
  }

  function printClaim() {
    const data = prepareData();
    if (!data) return;

    // –ú–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ "–∑–∞–∫–∞–∑-–Ω–∞—Ä—è–¥"
    data.header.status = 'zakaz_naryad';
    data.header.printedAt = firebase.database.ServerValue.TIMESTAMP;

    saveOrUpdateClaim(data);
    window.print();
    resetForm();
  }

  function resetForm() {
    document.getElementById('claim-id').value = '';
    document.getElementById('order-number').value = '';
    document.getElementById('client-company').value = '';
    document.getElementById('contact').value = '';
    document.getElementById('master').value = '';
    document.getElementById('client-name').value = '';
    document.getElementById('car-brand').value = '';
    document.getElementById('car-number').value = '';
    document.getElementById('mileage').value = '123456';

    document.getElementById('works-body').innerHTML = '';
    document.getElementById('completed-body').innerHTML = '';
    workIndex = 1;
    completedIndex = 1;
    generateOrderNumber();
  }

  function renderReadOnlyPreview(claim) {
    const preview = document.createElement('div');
    preview.style.padding = '20px';
    preview.style.background = '#fff';
    preview.style.border = '1px solid #ddd';
    preview.style.borderRadius = '8px';
    preview.innerHTML = `
      <h3>–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—è–≤–∫–∏ ‚Ññ${claim.header.order}</h3>
      <p><strong>–î–∞—Ç–∞:</strong> ${claim.header.date}</p>
      <p><strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${claim.header.clientCompany}</p>
      <p><strong>–ú–∞—Å—Ç–µ—Ä:</strong> ${claim.header.master}</p>
      <p><strong>–ê–≤—Ç–æ–º–æ–±–∏–ª—å:</strong> ${claim.header.carBrand} (${claim.header.carNumber})</p>
      <p><strong>–ü—Ä–æ–±–µ–≥:</strong> ${claim.header.mileage} –∫–º</p>

      <h4>–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–∞–±–æ—Ç—ã</h4>
      <table style="width:100%; border-collapse: collapse; margin: 10px 0;">
        <thead><tr><th>‚Ññ</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–ö–æ–ª-–≤–æ</th><th>–°—Ç–æ—Ä–æ–Ω–∞</th><th>–ü–æ–ª–æ–∂–µ–Ω–∏–µ</th></tr></thead>
        <tbody>
          ${claim.works.map(w => `<tr><td>${w.id}</td><td>${w.description}</td><td>${w.quantity}</td><td>${w.side}</td><td>${w.position}</td></tr>`).join('')}
        </tbody>
      </table>

      <h4>–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</h4>
      <table style="width:100%; border-collapse: collapse; margin: 10px 0;">
        <thead><tr><th>‚Ññ</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–ö–æ–ª-–≤–æ</th><th>–°—Ç–æ—Ä–æ–Ω–∞</th><th>–ü–æ–ª–æ–∂–µ–Ω–∏–µ</th><th>–¶–µ–Ω–∞</th></tr></thead>
        <tbody>
          ${claim.completed.map(c => `<tr><td>${c.id}</td><td>${c.description}</td><td>${c.quantity}</td><td>${c.side}</td><td>${c.position}</td><td>${c.price}</td></tr>`).join('')}
        </tbody>
      </table>

      <div style="margin-top: 20px; text-align: right;">
        <button class="btn" onclick="window.print()">üñ®Ô∏è –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å</button>
        <button class="btn" onclick="switchTab('archive')">‚Üê –ù–∞–∑–∞–¥ –≤ –∞—Ä—Ö–∏–≤</button>
      </div>
    `;
    document.body.innerHTML = '';
    document.body.appendChild(preview);
  }

  function loadArchive() {
    if (document.getElementById('archive-tab').classList.contains('active')) {
      renderArchive();
    }
  }
</script>

</body>
</html>
